name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: pip install uv

      - name: Sync dependencies
        run: uv sync --frozen --no-dev

      - name: Install Ruff
        run: uv pip install ruff
      
      - name: Run Ruff Linter
        # Check for linting errors and formatting issues without fixing them
        run: uv run ruff check .
      
      - name: Run Ruff Formatter Check
        # Check that all files are correctly formatted
        run: uv run ruff format . --check

      - name: Run unit tests
        run: uv run pytest -v app/test_inference.py

      - name: Build Docker image
        run: docker build -t youtube-sentiment-api .

      - name: Run health check
        run: docker run --rm -p 8000:8000 -d youtube-sentiment-api && sleep 10 && curl -f http://127.0.0.1:8000/health
